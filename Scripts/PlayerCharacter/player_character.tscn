[gd_scene load_steps=42 format=3 uid="uid://c5eoj2ew1c24k"]

[ext_resource type="Script" uid="uid://b8tm2dsp5o0p4" path="res://Scripts/StateMachine/StateMachine.gd" id="2_2qmth"]
[ext_resource type="PackedScene" uid="uid://c2f6gkn1nj3vd" path="res://Art/Player/Character/import/kora_toon_exporting_to_godot.glb" id="3_n4e6q"]
[ext_resource type="Script" uid="uid://cf1k2ydotw064" path="res://Scripts/PlayerCharacter/States/EnemyWander.gd" id="5_87sd3"]
[ext_resource type="Script" uid="uid://bm7xyyr5k284s" path="res://Scripts/PlayerCharacter/States/Slash.gd" id="6_afnhe"]
[ext_resource type="Script" uid="uid://cg7tsdk2ofmni" path="res://Scripts/PlayerCharacter/States/Locomote.gd" id="7_x7dml"]
[ext_resource type="Script" uid="uid://r14b1w2ap2jr" path="res://Scripts/PlayerCharacter/States/LeaningCrate.gd" id="8_myuww"]
[ext_resource type="Script" uid="uid://cso4uel115xs0" path="res://Scripts/PlayerCharacter/States/PushingCrate.gd" id="9_xe6gf"]
[ext_resource type="Script" uid="uid://dy3ag1l4iwq0g" path="res://Scripts/PlayerCharacter/States/Crouching.gd" id="10_q077h"]
[ext_resource type="Script" uid="uid://bcle844nc463r" path="res://Scripts/PlayerCharacter/States/Crawling.gd" id="11_3g0di"]
[ext_resource type="PackedScene" uid="uid://bflp5jntvmqk8" path="res://UI/MainMenu/MainMenu.tscn" id="13_tr5ml"]

[sub_resource type="GDScript" id="GDScript_fxc0a"]
script/source = "extends Node3D


# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	pass

func save():
	print(\"player_character save\")
	var save_dict = {
		\"filename\" : get_scene_file_path(),
		\"parent\" : get_parent().get_path(),
		\"pos_x\" : position.x,
		\"pos_y\" : position.y,
		\"pos_z\" : position.z
	}
	return save_dict
"

[sub_resource type="GDScript" id="GDScript_wg041"]
script/source = "extends RigidBody3D
class_name PlayerCharacter

@export var SPEED = 5.0
@export var LERP_SPEED = 0.35
@export var JUMP_VELOCITY = 4.5
@export var INVINCIBLE : bool = false

@export var animTree : AnimationTree
@export var stateMachine : StateMachine

# the team this entity is on - 1 = player, 2 = enemy
var team = 1

func _ready():
	stateMachine.TransitionTo(\"Locomote\")

func _process(delta):
	pass

@export var move_speed = 15



#	# Get the input direction and handle the movement/deceleration.
#	var input_dir = Input.get_vector(\"walk_west\", \"walk_east\", \"walk_north\", \"walk_south\")
#	
#	if input_dir:
#		playerCharacter.velocity.x = lerp(playerCharacter.velocity.x, input_dir.x * SPEED, LERP_SPEED)
#		playerCharacter.velocity.z = lerp(playerCharacter.velocity.z, input_dir.y * SPEED, LERP_SPEED)
#		
#		# rotate to face direction
#		## add the direction to the current position
#		var lookat_location = playerCharacter.global_transform.origin + Vector3(input_dir.x, 0, input_dir.y)
#		## lookat that location
#		playerCharacter.look_at(lookat_location, Vector3.UP)
#	else:
#		playerCharacter.velocity.x = lerp(playerCharacter.velocity.x, 0.0, LERP_SPEED)
#		playerCharacter.velocity.z = lerp(playerCharacter.velocity.z, 0.0, LERP_SPEED)
#	
#	animTree.set(\"parameters/StateMachine/Locomote/blend_position\", playerCharacter.velocity.length() / SPEED)
#	
#	
#	for i in playerCharacter.get_slide_collision_count():
#		var collider = playerCharacter.get_slide_collision(i).get_collider()
#		if(collider.has_method('push')):
#			# only if we are pushing towards a cardinal direction (no diagonals)
#			var input = Input.get_vector(\"walk_west\", \"walk_east\", \"walk_north\", \"walk_south\").round()
#			# one of the values in the vector must be zero
#			if input.x == 0 or input.y == 0 and input != Vector2.ZERO:
#				get_parent().TransitionTo(\"LeaningCrate\", collider)

func _physics_process(state):
	
	linear_damp = 25
	gravity_scale = 1
	if not $GroundCast.is_colliding():
		linear_damp = 0
		gravity_scale = 8


# called when we receive a hurt from somewhere
func receive_damage(damage:Damage):
	# only if we're not invincible
	if INVINCIBLE:
		return
	else:
		INVINCIBLE = true

	# stop all movement
#	velocity = Vector3.ZERO

	# play hurt animation
	animTree.set(\"parameters/BlendSpace1D/blend_position\", 0.0)
	# animTree.set(\"parameters/Hit\", true)
	# animTree.set(\"parameters/Hit\", false)
	
	# get the vector from the source to us
	var attackVector = global_transform.origin - damage.source.global_transform.origin
	# normalize it
	var normalizedAttackVector = attackVector.normalized()
	normalizedAttackVector.y = 0
	# apply impulse to player character
	apply_impulse(normalizedAttackVector * 4000)

	# flash the players visibility
	for n in 20:
		visible = !visible
		await get_tree().create_timer(0.05).timeout
	
	INVINCIBLE = false
"

[sub_resource type="AnimationNodeTimeScale" id="AnimationNodeTimeScale_alo0e"]

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_duqcs"]
animation = &"idle"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_4oav6"]
animation = &"walk"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_biff6"]
animation = &"run"

[sub_resource type="AnimationNodeBlendSpace1D" id="AnimationNodeBlendSpace1D_srys3"]
blend_point_0/node = SubResource("AnimationNodeAnimation_duqcs")
blend_point_0/pos = 0.0
blend_point_1/node = SubResource("AnimationNodeAnimation_4oav6")
blend_point_1/pos = 0.3
blend_point_2/node = SubResource("AnimationNodeAnimation_biff6")
blend_point_2/pos = 1.0
min_space = 0.0

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_sma0w"]
resource_local_to_scene = true
animation = &"slash"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_tvpiq"]
animation = &"crawl_idle"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_yxknk"]
animation = &"crawl"

[sub_resource type="AnimationNodeBlendSpace1D" id="AnimationNodeBlendSpace1D_ebfcu"]
blend_point_0/node = SubResource("AnimationNodeAnimation_tvpiq")
blend_point_0/pos = 0.1
blend_point_1/node = SubResource("AnimationNodeAnimation_yxknk")
blend_point_1/pos = 0.5

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_qhlp2"]
animation = &"crouch"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_4hbm8"]
animation = &"leaning_pushable"

[sub_resource type="AnimationNodeAnimation" id="AnimationNodeAnimation_g4gtf"]
animation = &"pushing_pushable"

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_gy7fs"]
advance_mode = 2

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_wbke6"]

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_eh4ht"]
advance_mode = 2

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_2l6ic"]

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_k38qc"]
xfade_time = 0.1

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_831vp"]
xfade_time = 0.1

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_epm4v"]
xfade_time = 0.1

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_3diy6"]
xfade_time = 0.1

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_uup32"]
xfade_time = 0.1

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_nw37k"]

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_e511p"]

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_sl7d2"]

[sub_resource type="AnimationNodeStateMachineTransition" id="AnimationNodeStateMachineTransition_nedae"]

[sub_resource type="AnimationNodeStateMachine" id="AnimationNodeStateMachine_61bxm"]
states/Locomote/node = SubResource("AnimationNodeBlendSpace1D_srys3")
states/Locomote/position = Vector2(400, 100)
states/Slash/node = SubResource("AnimationNodeAnimation_sma0w")
states/Slash/position = Vector2(288, -23)
states/crawling/node = SubResource("AnimationNodeBlendSpace1D_ebfcu")
states/crawling/position = Vector2(347, -174)
states/crouch/node = SubResource("AnimationNodeAnimation_qhlp2")
states/crouch/position = Vector2(406, -70)
states/leaning_pushable/node = SubResource("AnimationNodeAnimation_4hbm8")
states/leaning_pushable/position = Vector2(656, -70)
states/pushing_pushable/node = SubResource("AnimationNodeAnimation_g4gtf")
states/pushing_pushable/position = Vector2(672, 39)
transitions = ["Start", "Locomote", SubResource("AnimationNodeStateMachineTransition_gy7fs"), "Locomote", "End", SubResource("AnimationNodeStateMachineTransition_wbke6"), "Slash", "Locomote", SubResource("AnimationNodeStateMachineTransition_eh4ht"), "Locomote", "Slash", SubResource("AnimationNodeStateMachineTransition_2l6ic"), "Locomote", "leaning_pushable", SubResource("AnimationNodeStateMachineTransition_k38qc"), "leaning_pushable", "pushing_pushable", SubResource("AnimationNodeStateMachineTransition_831vp"), "pushing_pushable", "leaning_pushable", SubResource("AnimationNodeStateMachineTransition_epm4v"), "pushing_pushable", "Locomote", SubResource("AnimationNodeStateMachineTransition_3diy6"), "leaning_pushable", "Locomote", SubResource("AnimationNodeStateMachineTransition_uup32"), "Locomote", "crouch", SubResource("AnimationNodeStateMachineTransition_nw37k"), "crouch", "Locomote", SubResource("AnimationNodeStateMachineTransition_e511p"), "crouch", "crawling", SubResource("AnimationNodeStateMachineTransition_sl7d2"), "crawling", "crouch", SubResource("AnimationNodeStateMachineTransition_nedae")]
graph_offset = Vector2(-10, -211)

[sub_resource type="AnimationNodeBlendTree" id="AnimationNodeBlendTree_d3hs1"]
nodes/output/position = Vector2(220, 100)
nodes/AnimSpeed/node = SubResource("AnimationNodeTimeScale_alo0e")
nodes/AnimSpeed/position = Vector2(60, 100)
nodes/StateMachine/node = SubResource("AnimationNodeStateMachine_61bxm")
nodes/StateMachine/position = Vector2(-120, 100)
node_connections = [&"output", 0, &"AnimSpeed", &"AnimSpeed", 0, &"StateMachine"]

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_htfwu"]
radius = 0.15
height = 0.8

[sub_resource type="GDScript" id="GDScript_7d1ii"]
script/source = "class_name PlayerCameraPivot
extends Node3D

@onready var player = $\"../PlayerCharacter\"

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	# lock the pivot location to the players location
	# in the future this can be smoothed or whatever
	transform.origin = player.transform.origin
	pass
"

[node name="Node3D" type="Node3D"]
script = SubResource("GDScript_fxc0a")

[node name="PlayerCharacter" type="PlayerCharacter3D" parent="."]
_import_path = NodePath("")
unique_name_in_owner = false
process_mode = 0
process_priority = 0
process_physics_priority = 0
process_thread_group = 0
physics_interpolation_mode = 0
auto_translate_mode = 0
editor_description = ""
script = SubResource("GDScript_wg041")

[node name="SkinnedMesh" parent="PlayerCharacter" instance=ExtResource("3_n4e6q")]
transform = Transform3D(-1, 0, -6.28631e-06, 0, 1, 0, 6.28631e-06, 0, -1, 0, 0, 0)

[node name="GeneralSkeleton" parent="PlayerCharacter/SkinnedMesh/rig" index="0"]
bones/1/position = Vector3(-8.51625e-05, -0.00748478, 0.00171648)
bones/1/rotation = Quaternion(0.0211592, 0.000476636, 0.0225156, 0.999522)
bones/2/rotation = Quaternion(-2.98023e-08, -1.63607e-09, 9.98106e-10, 1)
bones/3/rotation = Quaternion(-2.98023e-08, 1.86264e-09, 0, 1)
bones/4/position = Vector3(0.00449537, 0.0691386, -0.00177577)
bones/4/rotation = Quaternion(1.98954e-07, -1.22236e-08, -1.42754e-08, 1)
bones/5/rotation = Quaternion(-5.94882e-08, 3.72529e-09, 7.45058e-09, 1)
bones/10/rotation = Quaternion(0.101884, 0.986707, 0.111957, 0.0591078)
bones/10/scale = Vector3(0.99917, 0.998409, 1.00243)
bones/11/rotation = Quaternion(-0.00771391, -0.00137848, -0.0175177, 0.999816)
bones/12/rotation = Quaternion(-0.0178558, -0.630586, -0.0366989, 0.775046)
bones/12/scale = Vector3(1.00551, 0.998707, 0.995841)
bones/13/rotation = Quaternion(0.0112346, 0.00305095, 0.00625485, 0.999913)
bones/14/rotation = Quaternion(0.0813012, 0.784628, -0.0343792, 0.61365)
bones/14/scale = Vector3(0.997224, 1.00147, 1.00141)
bones/16/rotation = Quaternion(-0.0408005, 0.995014, 0.0760528, -0.0499926)
bones/16/scale = Vector3(0.999155, 0.999014, 1.00183)
bones/17/rotation = Quaternion(0.0778553, -0.048751, -0.276283, 0.956676)
bones/18/rotation = Quaternion(-0.360148, 0.470755, -0.503434, 0.628679)
bones/18/scale = Vector3(1.00157, 1.00899, 0.989845)
bones/19/rotation = Quaternion(-0.167238, -0.0756648, 0.275246, 0.943688)
bones/20/rotation = Quaternion(0.153441, -0.478498, 0.408706, 0.761876)
bones/20/scale = Vector3(1.00689, 1.0018, 0.991653)
bones/26/rotation = Quaternion(0, 0.000561172, 0.0132491, 0.999912)
bones/27/rotation = Quaternion(-5.95464e-08, 1.86264e-09, -3.72529e-09, 1)
bones/28/rotation = Quaternion(1.19306e-07, 0.00056118, 0.0132491, 0.999912)
bones/34/rotation = Quaternion(-0.00851069, -0.208564, 0.977959, 0.00498407)
bones/34/scale = Vector3(0.997645, 1.00257, 0.999813)
bones/35/rotation = Quaternion(-6.04297e-05, 0.00175765, 0.00116609, 0.999998)
bones/36/rotation = Quaternion(-0.0299531, 0.986815, 0.158617, 0.011784)
bones/36/scale = Vector3(0.996578, 1.00804, 0.99541)
bones/37/rotation = Quaternion(0.0103653, -0.0592619, -0.0284403, 0.997783)
bones/38/rotation = Quaternion(-0.0893237, 0.804664, -0.581918, 0.0768679)
bones/38/scale = Vector3(1.00535, 0.955692, 1.04005)
bones/39/rotation = Quaternion(2.22516e-10, 1, 0, -6.82983e-10)
bones/42/rotation = Quaternion(0.046084, 0.30887, 0.942387, 0.119926)
bones/42/scale = Vector3(0.996292, 1.00487, 0.998911)
bones/43/rotation = Quaternion(0.000669732, -0.00551585, 0.00309405, 0.99998)
bones/44/rotation = Quaternion(0.103537, 0.910806, 0.399199, 0.0188085)
bones/44/scale = Vector3(0.997677, 0.997535, 1.00482)
bones/45/rotation = Quaternion(0.00527939, -0.00678854, 0.0181629, 0.999798)
bones/46/rotation = Quaternion(-0.00058797, 0.821028, -0.54393, -0.173359)
bones/46/scale = Vector3(1.00672, 1.02873, 0.965127)
bones/47/rotation = Quaternion(2.46954e-10, 1, 0, -2.46954e-10)
bones/49/position = Vector3(-0.00746217, 0.233924, -0.0504478)
bones/49/rotation = Quaternion(0.0211392, 0.00103736, 0.0490059, 0.998574)
bones/50/rotation = Quaternion(7.0569e-05, 0.000257862, -0.0132262, 0.999913)
bones/51/rotation = Quaternion(0.00364783, -0.00885626, 0.0193661, 0.999767)
bones/52/rotation = Quaternion(0.00275163, -0.0240208, 0.0330419, 0.999161)
bones/53/rotation = Quaternion(-6.98492e-09, -2.79397e-09, 1.5134e-08, 1)
bones/54/rotation = Quaternion(-2.98096e-08, 9.31323e-10, -5.82077e-11, 1)
bones/55/rotation = Quaternion(5.96919e-08, 3.72529e-09, -2.91038e-09, 1)
bones/56/rotation = Quaternion(-0.0855502, -0.0126747, 0.00893313, 0.996213)
bones/57/rotation = Quaternion(0.105585, 0.0231734, -0.0150576, 0.994026)
bones/58/position = Vector3(6.91008e-15, 0.778006, 0.467975)

[node name="AnimationTree" type="AnimationTree" parent="PlayerCharacter/SkinnedMesh"]
tree_root = SubResource("AnimationNodeBlendTree_d3hs1")
anim_player = NodePath("../AnimationPlayer")
parameters/AnimSpeed/scale = 1.0
parameters/StateMachine/Locomote/blend_position = -0.0275049
parameters/StateMachine/crawling/blend_position = 0.0

[node name="CollisionShape3D" type="CollisionShape3D" parent="PlayerCharacter"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.42, 0)
shape = SubResource("CapsuleShape3D_htfwu")

[node name="StateMachine" type="Node" parent="PlayerCharacter" node_paths=PackedStringArray("initial_state")]
script = ExtResource("2_2qmth")
initial_state = NodePath("Locomote")

[node name="EnemyWander" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("5_87sd3")

[node name="Slash" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("6_afnhe")

[node name="Locomote" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("7_x7dml")

[node name="LeaningCrate" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("8_myuww")

[node name="PushingCrate" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("9_xe6gf")

[node name="Crouching" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("10_q077h")

[node name="Crawling" type="Node" parent="PlayerCharacter/StateMachine"]
script = ExtResource("11_3g0di")

[node name="PlayerCameraPivot" type="Node3D" parent="."]
script = SubResource("GDScript_7d1ii")

[node name="Camera3D" type="Camera3D" parent="PlayerCameraPivot"]
transform = Transform3D(1, 0, 0, 0, 0.658125, 0.752909, 0, -0.752909, 0.658125, -4.76837e-07, 5.11775, 3.42914)

[node name="Control" parent="PlayerCameraPivot/Camera3D" instance=ExtResource("13_tr5ml")]
visible = false

[node name="GroundCast" type="RayCast3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.0634478, 0.00461194)
target_position = Vector3(0, -0.15, 0)

[editable path="PlayerCharacter/SkinnedMesh"]
